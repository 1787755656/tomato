# Makefile.in for kernel module

SHELL = /bin/sh
INSTALL = @INSTALL@
mkdir_p = mkdir -p
DEPMOD = /sbin/depmod -a
majver = @majver@
VERSION = @PACKAGE_VERSION@

DISTFILES = Makefile.in configure.ac configure config.h.in ../install-sh \
	dev.c dir.c file.c inode.c fuse_i.h fuse_kernel.h
COMPATDISTFILES = compat/parser.c compat/parser.h

fusemoduledir = $(INSTALL_MOD_PATH)@kmoduledir@/fs/fuse

ifeq ($(majver), 2.4)
fusemodule := fuse.o
else
fusemodule := fuse.ko
endif

ifndef MAKING_MODULES
all: all-@ENABLE_FUSE_MODULE@
all-y: all-spec
endif
install: install-@ENABLE_FUSE_MODULE@
uninstall: uninstall-@ENABLE_FUSE_MODULE@

all-n:
install-n:
uninstall-n:

install-y: all
	$(mkdir_p) $(fusemoduledir)
	$(INSTALL) -m 644 $(fusemodule) $(fusemoduledir)/$(fusemodule)
	-$(DEPMOD)

uninstall-y:
	rm -f $(fusemoduledir)/$(fusemodule)
	-$(DEPMOD)

clean:
	-rm -f $(fusemodule) *.o .*.cmd *.mod.c *.ko *.s */*.o

distclean: clean
	rm -f Makefile
	rm -f config.h config.log config.status config.cache
	rm -rf .tmp_versions

maintainer-clean: distclean

distdir: $(DISTFILES) $(COMPATDISTFILES)
	cp -p $(DISTFILES) $(distdir)
	mkdir $(distdir)/compat
	cp -p $(COMPATDISTFILES) $(distdir)/compat


EXTRA_CFLAGS += -DFUSE_VERSION=\"$(VERSION)\"
KERNELDIR := @kernelsrc@

ifeq ($(majver), 2.4)

fuse-objs := dev.o dir.o file.o inode.o compat/parser.o

O_TARGET := $(fusemodule)

obj-y := $(fuse-objs)
obj-m := $(O_TARGET)

fuse_headers = fuse_i.h fuse_kernel.h

dev.o: $(fuse_headers)
dir.o: $(fuse_headers)
file.o: $(fuse_headers)
inode.o: $(fuse_headers)
compat/parser.o: compat/parser.h

IGNORE_FLAGS_OBJS=compat/parser.o
TOPDIR := $(KERNELDIR)

include $(TOPDIR)/Rules.make

else

obj-m := fuse.o
fuse-objs := dev.o dir.o file.o inode.o

endif

all-spec:
	$(MAKE) -C $(KERNELDIR) SUBDIRS=$(PWD) @KERNELMAKE_PARAMS@ CC=@CC@ modules
